#!/usr/bin/env bash
#############################################################################
# RunFlexSpec   dispatch server launcher
# /home/git/external/FlexSpec1/Code/FlexSpec/UserInterface/RunFlexSpec
# bokeh serve ./FlexSpec.py --unused-session-lifetime 3600000 --address 127.0.0.1
# uses: /home/git/external/FlexSpec1/Code/SBC/FlexSpecServer.py
#
# run from remote browser to: http://pier15.local/flexspec/ 
#############################################################################

__version="0.0.1"

function usage {
   echo "Version $__version"
   echo "RunFlexSpec ... switches"
   echo "  -p show currently running ports listening to 5006"
   echo "  -t <intervaltime> in microseconds 3600000 is one hour."
   echo "  -s - use show flag with bokeh."
   echo "  -v - pass verbose flag to FlexSpec."
   echo "  -h - show help an quit."
   echo "Run the $__version spectrograph interface."
   echo "Hint: ps aux | grep RunFlexSpec; # and kill -9 the pid as needed."
   echo "sudo ss -lptn 'sport = :5006' # find pid for a port to kill -9"
}

mswitch=""
intervaltime="3600000"
verboseflag=""
showflag=""
currpid=""

lsof -i :5006 | gawk -e '/bokeh/ {print "killing bokeh ",$2, system("kill -9 " $2); exit}'


sigint_handler()
{
   if [ "$currpid" != ""];  then kill -i "$pid"; fi
   echo "RunFlexSpec: Terminated $pid."
}

trap sigint_handler SIGINT


# leading colon is silent. ":hb:" h has no option, b has an option.
while getopts ":hpsvt:" opt ; do     # request to use master bib
   case $opt in
   h)
      usage
      exit 1
      ;; # process a two part parm
   p)
       lsof -i :5006
       exit
       ;;
   s)
       showeflag="show"
      ;;
   v)
      verboseflag="-v"
      ;;
   t)
       intervaltime=${OPTARG}
      ;;
   esac
done

../../SBC/FlexSpecServer.py "$verboseflag" &

# Finally! The command we want to run.

export flexprefix="-- prefix /flexspec"
export port=eth0
export bkhost="--allow-websocket-origin=pier15.local"
export bkcmd=" exec bokeh serve $show ./FlexSpec.py $bkhost --unused-session-lifetime $intervaltime"

if test "$verboseflag" == "" ; then
   echo "   port   $port"
   echo "   bkhost $bkhost"
   echo "   bkcmd  $bkcmd"
fi

# echo pid; then the command.
currpid=$(echo $$; bokeh serve ./FlexSpec.py $bkhost --unused-session-lifetime $intervaltime)

